<?php
require_once($_SERVER['DOCUMENT_ROOT'].'/include/config.php');
header("Content-Type: application/json; charset=utf-8");

$strJsonGameString = $_POST['data'];
//$strJsonGameString = '[1,150,["[[[[[0,218.4735790300206,1470],[0,215.89057393885528,1521],[0,214.0353470787981,1573],[0,213.8427368956466,1624],[0,216.2581082607704,1676],[0,215.89480991367057,1725],[0,215.54234263321203,1780],[0,216.21072523921382,1832],[0,217.24989639345975,1882],[0,217.24029496415113,1931],[0,217.6788538648562,1982],[0,218.37685131519476,2032],[0,217.84225842867335,2084],[0,218.19351626326937,2134],[0,219.50673120308969,2184],[0,219.1487665019202,2236],[0,220.56613256578578,2287],[0,223.91458906308648,2339],[0,224.6867668792795,2390],[0,226.63449755571443,2441],[0,225.98761622829244,2494],[0,226.04442869921243,2548],[0,226.8764343357747,2598],[0,226.5890198421994,2648],[0,227.00833521640416,2698],[0,229.37053407137813,2748],[0,233.92507327120785,2799],[30.535279463466335,239.99352794634663,2850],[49.32850096821085,252.0071499031789,2901],[0,264.34191989833903,2951],[0,271.23821714582346,3002]],{\"percent\":0,\"factor\":0.65,\"text\":\"Miserable\",\"color\":\"#900\"},31,\"B\",3]]]","[[[[[8.204236028160494,268.00042360281606,3056],[14.686359329573975,268.6486359329574,3104],[0,266.9615638839764,3155],[0,265.3281614287094,3206],[0,266.13529328944117,3257],[0,266.2554975337695,3309],[0,266.0537015317529,3358],[0,265.4509073756524,3409],[0,264.1109050421607,3460],[0,264.8186662113258,3516],[0,266.7212660973435,3567],[0,265.9150692361581,3618],[0,265.3607863088152,3668],[0,265.48950957677204,3718],[0,265.5736105415627,3768],[0,265.5775311096304,3819],[0,266.3222897669524,3870],[0,266.34713759069194,3921],[0,263.74251240314885,3973],[0,264.4333724560076,4022],[0,266.2530185316051,4073],[0,266.1605716473088,4125],[0,265.4082939344051,4174],[0,266.66816244428077,4225],[4.9049267566721255,267.6704926756672,4276],[26.324171907511413,269.81241719075115,4327],[85.94379293906798,275.7743792939068,4377],[58.71183927809,281.308816072191,4428],[32.386713485125824,283.9413286514874,4478],[0,287.5972600699903,4534],[0,288.60008205321543,4583]],{\"percent\":0,\"factor\":0.65,\"text\":\"Miserable\",\"color\":\"#900\"},90,\"C#\",4]]]","[[[[[57.629752580288596,289.4229752580289,4637],[74.06858267926168,291.0668582679262,4685],[83.92298811780165,292.0522988117802,4735],[86.90488441406274,292.3504884414063,4786],[96.84718395291384,293.97528160470864,4836],[78.83837334496263,295.77616266550376,4889],[89.98675769993497,294.6613242300065,4940],[96.15125077479092,293.2751250774791,4988],[99.34961298663836,293.59496129866386,5039],[93.36971081559909,294.3230289184401,5090],[97.1360562932199,293.94639437067804,5141],[97.63304276306826,293.42330427630685,5191],[94.32219897831885,293.0922198978319,5244],[98.06388501048389,293.4663885010484,5294],[86.79819920870386,292.3398199208704,5352],[83.8267907627187,292.0426790762719,5403],[87.76851856175767,292.4368518561758,5454],[88.28185273771396,292.4881852737714,5503],[67.61187178631815,290.42118717863184,5554],[58.0354797204825,289.4635479720483,5603],[89.98428885763303,292.6584288857633,5654],[88.97384332792171,294.76261566720785,5705],[90.82442869797717,294.5775571302023,5758],[95.90504264349988,294.06949573565004,5808],[69.71056494385437,290.63105649438546,5859],[68.1640608057296,290.476406080573,5910],[93.53525073744379,293.0135250737444,5961],[98.03737028687522,293.8562629713125,6012],[95.03851407185152,294.1561485928149,6063],[92.62379677828392,294.39762032217163,6117],[84.39626108034133,295.2203738919659,6168]],{\"percent\":80,\"factor\":0.95,\"text\":\"Good\",\"color\":\"#0D0\"},1521,\"D\",4]]]","[[[[[0,298.07270846942134,6221],[0,305.47435490347385,6269],[0,315.56826358295746,6319],[30.272749283305416,322.65727492833054,6370],[54.93273748920501,325.1232737489205,6420],[59.553074188657426,325.58530741886574,6469],[37.132651885311816,323.3432651885312,6520],[8.83032491483391,320.5130324914834,6571],[7.313112712812426,320.36131127128124,6622],[6.884249565230789,320.3184249565231,6672],[15.089315081967811,321.1389315081968,6723],[16.233594782987666,321.25335947829876,6774],[8.300644072579644,320.46006440725796,6825],[6.170895238834078,320.2470895238834,6875],[3.383685989445553,319.96836859894455,6927],[0.18875998521423298,319.6488759985214,6979],[4.453130254805728,320.07531302548057,7032],[14.437370534538447,321.07373705345384,7083],[6.105750427286694,320.24057504272866,7133],[8.376957521730901,320.4676957521731,7183],[14.16113772196354,321.04611377219635,7233],[10.286964424314533,320.65869644243145,7285],[18.78842688137354,321.50884268813735,7336],[41.17973966277873,323.74797396627787,7387],[57.330653524239786,325.363065352424,7438],[59.525327693568784,325.5825327693569,7488],[60.21878007445422,325.6518780074454,7539],[59.70390466683171,325.60039046668317,7589],[67.04652023789663,326.33465202378966,7640],[74.74115363873238,327.10411536387323,7692],[79.37473740274811,327.5674737402748,7743]],{\"percent\":10,\"factor\":0.65,\"text\":\"Rubbish\",\"color\":\"#C60\"},322,\"E\",4]]]","[[[[[0,329.69980837069977,7796],[0,335.31752257304964,7845],[0,347.36355082246257,7898],[4.708001667675035,360.4608001667675,7950],[44.160676424024246,364.40606764240243,8000],[26.34949477519399,362.6249494775194,8050],[0.5376627372038456,360.0437662737204,8102],[0,356.3387417766082,8152],[0,356.2324867986022,8203],[0,359.6008429460267,8254],[9.714539272690672,360.9614539272691,8304],[9.133267668372014,360.9033267668372,8355],[1.0560378726859199,360.0956037872686,8406],[0,357.76233963329224,8457],[0,356.0667749295614,8509],[0,356.16571448790046,8559],[0,358.6278359538731,8610],[21.222664256611665,362.1122664256612,8661],[17.499100805045487,361.73991008050456,8712],[22.25172705539876,362.2151727055399,8763],[22.86937125626423,362.27693712562643,8816],[13.158943626694395,361.30589436266945,8866],[3.0373901518242974,360.29373901518244,8917],[1.799830376632485,360.16998303766326,8968],[20.905958946550527,362.08059589465506,9020],[38.96175288028758,363.88617528802877,9071],[40.14093279737949,364.00409327973796,9122],[53.37835343619475,365.3278353436195,9173],[69.9928422513807,366.9892842251381,9224],[75.31929791651294,367.5219297916513,9276],[76.14820644600513,372.3751793553995,9325]],{\"percent\":10,\"factor\":0.65,\"text\":\"Rubbish\",\"color\":\"#C60\"},222,\"F#\",4]]]","[[[[[0,381.4198635022183,9378],[99.56517320717182,391.9565173207172,9428],[34.38902172068026,398.561097827932,9479],[18.246438760465367,400.17535612395346,9529],[26.84288429703884,399.3157115702961,9581],[34.01844500590187,398.5981554994098,9632],[22.360300416032715,399.76396995839673,9689],[2.276112588336332,401.77238874116637,9739],[51.208975146227544,396.87910248537725,9789],[47.20982553947238,397.27901744605276,9840],[28.733454330898102,399.1266545669102,9889],[53.96010589414117,396.6039894105859,9940],[65.08217586345893,395.4917824136541,9991],[68.99094839398913,395.1009051606011,10042],[85.36807938999118,393.4631920610009,10093],[98.52125910048414,391.8521259100484,10144],[89.36559685764053,393.06344031423595,10194],[81.48753838946732,393.85124616105327,10246],[85.42404675978503,393.4575953240215,10296],[71.73652326142985,394.826347673857,10346],[79.47240924258836,394.05275907574116,10397],[77.18131844771278,394.2818681552287,10450],[63.072573361061465,395.69274266389385,10503],[38.66447560583708,398.1335524394163,10552],[36.30582234739052,398.36941776526095,10604],[36.5177992985582,398.3482200701442,10654],[46.69322446876663,397.33067755312334,10705],[52.43573584235946,396.75642641576405,10755],[54.77590984601704,396.5224090153983,10806],[55.55100646686639,396.44489935331336,10857],[8.337151903932067,401.1662848096068,10908]],{\"percent\":45,\"factor\":0.8,\"text\":\"Average\",\"color\":\"#990\"},770,\"G\",4]]]","[[[[[0,411.5124025043662,10960],[0,415.31769974997354,11010],[0,417.8436767505708,11065],[0,422.67000309373145,11113],[0,425.85665193099203,11164],[0,427.32120359440853,11216],[0,427.15761598075613,11273],[0,420.41476495915157,11324],[0,420.6310834521971,11374],[0,420.93226262451793,11425],[0,418.70654813741396,11475],[0,418.39138862923136,11525],[0,422.19353783088786,11576],[0,424.26111040006384,11627],[0,421.9056256416448,11679],[0,420.6175461067954,11730],[0,421.8337715973921,11781],[0,425.40463844272665,11832],[0,425.4061871385689,11884],[0,427.80369378316345,11934],[12.034936244391474,431.20349362443915,11991],[0,429.57275279731556,12039],[0,427.0102969105744,12090],[0,426.83408935016325,12141],[0,428.5654010578066,12192],[0,428.22277217165373,12243],[3.197463582804403,430.31974635828044,12297],[94.25355396721216,439.4253553967212,12347],[0,453.6411106237849,12397],[0,472.89665639235596,12448]],{\"percent\":0,\"factor\":0.65,\"text\":\"Miserable\",\"color\":\"#900\"},44,\"A\",4]]]","[[[[[0,472.3551196266168,12502],[0,471.25743668851953,12552],[0,472.1846732799526,12607],[0,474.1136495424605,12657],[0,479.26843746139724,12710],[0,477.97873673232857,12759],[0,475.0554589584902,12809],[0,474.90986925002943,12860],[0,470.1471908040028,12911],[0,468.7628438124394,12962],[0,474.32379803085416,13013],[0,481.927015392857,13065],[11.535550253726115,485.0335550253726,13117],[0,480.2425603339284,13167],[0,477.09232818116976,13218],[0,481.84514679497795,13267],[32.1407842894979,487.0940784289498,13318],[0,476.45464442578384,13371],[0,473.74660740040804,13421],[0,473.91262230114734,13477],[0,481.7753251803011,13526],[52.46218960542478,489.1262189605425,13576],[37.63844770627941,487.64384477062794,13627],[26.807990766737362,486.56079907667373,13678],[0,448.54894470600107,13729],[0,232.6780357577884,13780],[0,278.45837823420345,13831],[0,250.660962521403,13882],[0,227.2508062934698,13935],[0,221.24634022109524,13986],[0,-1,14037]],{\"percent\":0,\"factor\":0.65,\"text\":\"Miserable\",\"color\":\"#900\"},62,\"B\",4]]]","[[[[[0,-1,14093],[0,-1,14141],[0,-1,14191],[0.11976151300586933,430.0119761513006,14242],[0.11976151300586933,430.0119761513006,14293],[0,427.9518558401659,14343],[0,-1,14394],[51.9786696710139,435.1978669671014,14442],[91.5183833916376,439.15183833916376,14493],[0,-1,14546],[0,-1,14596],[0,-1,14647],[0,-1,14700],[0,-1,14750],[0,-1,14801],[0,459.4128302786804,14852],[0,-1,14903],[0,-1,14952],[0,-1,15009],[0,-1,15060],[0,473.3645982855365,15110],[0,472.09212989818445,15161],[0,471.00756291299797,15212],[0,-1,15263],[0,-1,15314],[0,-1,15365],[0,-1,15416],[0,-1,15468],[0,-1,15519],[0,-1,15570],[0,-1,15621]],{\"percent\":0,\"factor\":0.65,\"text\":\"Miserable\",\"color\":\"#900\"},56,\"A\",4]]]","[[[[[0,-1,15678],[94.5965731391874,392.54034268608126,15727],[40.77000008867287,397.9229999911327,15777],[50.74087487893166,396.92591251210683,15826],[23.624060929145116,399.6375939070855,15877],[37.8534621571373,398.21465378428627,15930],[58.771173140924596,396.12288268590754,15981],[0,-1,16033],[0,-1,16084],[35.412396494363065,398.4587603505637,16135],[33.56171849896839,398.64382815010316,16186],[31.847934475820804,398.8152065524179,16238],[27.786892064376616,399.22131079356234,16295],[36.31052704492447,398.36894729550755,16344],[69.02943962968038,395.09705603703196,16396],[74.70045247291694,394.5299547527083,16446],[0,-1,16496],[0,-1,16545],[0,410.63223929814495,16597],[0,412.60430150080504,16647],[0,-1,16698],[25.742973214912013,399.4257026785088,16749],[25.742973214912013,399.4257026785088,16800],[0,402.80457225138287,16851],[5.18395054128689,401.4816049458713,16903],[36.55674871972735,398.34432512802726,16955],[51.12226290120419,396.8877737098796,17009],[76.97296096719299,394.3027039032807,17066],[79.05636058275547,394.09436394172445,17124],[94.87504497311647,392.51249550268835,17161],[0,-1,17213]],{\"percent\":30,\"factor\":0.65,\"text\":\"Poor\",\"color\":\"#F90\"},392,\"G\",4]]]","[[[[[3.6981632632199535,360.359816326322,17267],[10.253363209997701,361.0153363209998,17315],[29.695917494550482,362.95959174945506,17371],[37.80456759468393,363.7704567594684,17416],[2.362010572049371,360.22620105720495,17464],[2.6847498149572857,360.25847498149574,17516],[7.4238864927463055,360.73238864927464,17570],[8.667994446559533,360.85679944465596,17618],[20.10048722874899,362.0000487228749,17670],[0,358.4778192236698,17724],[0,355.0777505972657,17775],[0,355.91418774831226,17824],[0,357.5618316846081,17875],[0,358.7503733176973,17926],[0,358.14539952011773,17976],[0,359.42176710644713,18027],[0,359.6243487392592,18078],[0,-1,18129],[54.55747014755048,365.44574701475506,18180],[35.94502389598688,363.5845023895987,18231],[40.45887331860001,364.03588733186,18282],[45.631969232625806,364.5531969232626,18334],[32.215950210040205,363.21159502100403,18385],[14.72419491720757,361.46241949172077,18436],[5.27284796134893,360.5172847961349,18486],[0,359.6425057328383,18539],[0,358.71113308584444,18593],[0.46835497442430096,360.03683549744244,18645],[3.0251882572633804,360.29251882572635,18706],[0,359.3889716816993,18744]],{\"percent\":10,\"factor\":0.65,\"text\":\"Rubbish\",\"color\":\"#C60\"},142,\"F#\",4]]]","[[[[[0,356.2877518082768,18795],[0,-1,18844],[0,-1,18896],[0,-1,18947],[33.606742454471714,322.99067424544717,19000],[44.80623541412399,324.1106235414124,19052],[49.89945618685795,324.6199456186858,19103],[35.04734272301505,323.1347342723015,19154],[15.257152209509856,321.155715220951,19204],[19.91791015429385,321.6217910154294,19255],[70.28538398179194,326.6585383981792,19306],[72.18930450181745,326.84893045018174,19357],[57.59329275465973,325.38932927546597,19413],[29.378338532028465,322.56783385320284,19461],[26.741825861965935,322.3041825861966,19512],[44.66278594681569,324.09627859468156,19562],[48.7661906695098,324.506619066951,19614],[38.89186763067016,323.519186763067,19665],[31.114265614739907,322.741426561474,19716],[55.84159009277698,325.2141590092777,19767],[61.65016894422421,325.7950168944224,19817],[45.30712173799657,324.16071217379965,19868],[25.53330476642202,322.1833304766422,19921],[35.32234506521149,323.16223450652114,19973],[57.61279311100906,325.3912793111009,20024],[65.97873941943931,326.2278739419439,20078],[62.13473441825841,325.84347344182584,20129],[57.33203647371283,325.3632036473713,20179],[58.83573779952428,325.5135737799524,20230],[60.07850731530482,325.6378507315305,20281],[35.95247365674538,323.22524736567453,20331]],{\"percent\":30,\"factor\":0.65,\"text\":\"Poor\",\"color\":\"#F90\"},481,\"E\",4]]]","[[[[[0,321.1255245442192,20384],[0,320.6615464523831,20433],[0,318.3391249649975,20484],[0,-1,20534],[80.04033535908889,295.65596646409114,20585],[89.7060265571713,292.63060265571715,20635],[91.33696320861532,294.5263036791385,20686],[70.54657481941547,296.6053425180585,20736],[81.73237035487432,295.4867629645126,20786],[96.86464480687675,293.3464644806877,20839],[84.35262517717945,295.2247374822821,20891],[93.25508900140335,294.3344910998597,20942],[90.71513240872378,292.7315132408724,20999],[97.70044840599724,293.43004484059975,21050],[80.89013706067192,295.57098629393283,21100],[83.49505114218573,295.31049488578145,21151],[97.33639922358066,293.92636007764196,21202],[60.645872187031955,297.59541278129683,21254],[69.00835609530247,296.7591643904698,21304],[88.3768172214701,292.49768172214704,21356],[66.40769128668694,290.3007691286687,21407],[70.17953686443946,290.67795368644397,21458],[88.71562644793926,294.7884373552061,21508],[60.03270842842653,297.6567291571574,21559],[68.27431880266658,296.83256811973337,21612],[97.58487048498637,293.41848704849866,21664],[93.61871042080509,293.02187104208053,21713],[66.11327746444317,297.0486722535557,21764],[59.35469103068443,297.7245308969316,21814],[99.94838497195417,293.65483849719544,21863],[97.00808552203569,293.95919144779646,21914]],{\"percent\":60,\"factor\":0.9,\"text\":\"Fair\",\"color\":\"#FF0\"},1194,\"D\",4]]]","[[[[[0,296.57083680164794,21966],[0,-1,22015],[0,-1,22067],[0,262.5790398652002,22119],[0,260.93446838731575,22172],[0,266.49848877010623,22224],[0,266.49848877010623,22274],[10.799473655729912,268.259947365573,22325],[32.570056029206285,270.43700560292064,22376],[5.333227654957113,267.7133227654957,22427],[0,266.43470023386794,22481],[27.427483719061456,269.92274837190615,22531],[59.09935787477594,273.0899357874776,22581],[60.891449033625236,273.26914490336253,22632],[37.85018420744052,270.96501842074406,22684],[32.236373881272016,270.4036373881272,22735],[65.94347663916153,273.77434766391616,22790],[60.69431918844316,273.2494319188443,22841],[42.527037948052,271.4327037948052,22893],[63.55429207240775,273.5354292072408,22941],[85.82911823439645,278.59708817656036,22993],[51.04101707060067,282.07589829293994,23047],[66.7309467499922,280.5069053250008,23098],[60.10760021170085,273.1907600211701,23147],[42.96093224587082,271.4760932245871,23199],[69.07684637494242,274.08768463749425,23249],[95.18731387471576,277.66126861252843,23300],[72.32786332462524,279.9472136675375,23352],[96.47661937849136,277.53233806215087,23404],[77.26498474746336,274.90649847474634,23454],[0,-1,23505]],{\"percent\":30,\"factor\":0.65,\"text\":\"Poor\",\"color\":\"#F90\"},472,\"C#\",4]]]","[[[[[0,-1,23558],[38.20413979807768,240.76041397980777,23607],[21.895918772030143,239.129591877203,23658],[22.77812232131538,239.21781223213154,23707],[26.405143253910808,239.58051432539108,23758],[2.393411466472344,237.17934114664723,23814],[39.30210691040486,240.87021069104048,23861],[85.71836984801081,248.36816301519892,23914],[60.12425057975748,250.92757494202425,23965],[83.50659997745822,245.29065999774582,24015],[33.83890785264839,240.32389078526484,24066],[37.82458233754738,240.72245823375474,24115],[95.9181286698066,246.53181286698066,24168],[60.07842286480383,250.93215771351962,24219],[61.15785159258081,250.82421484074192,24268],[98.5734358585836,247.08265641414164,24319],[80.71425067476127,245.01142506747613,24370],[83.87687706946366,245.32768770694636,24421],[72.07754510370847,244.14775451037085,24475],[14.494857354022486,238.38948573540225,24524],[0,236.6765698058101,24576],[75.2124431520491,244.4612443152049,24629],[54.96001613530183,251.44399838646981,24680],[65.39866399484055,250.40013360051594,24730],[73.83842841204739,244.32384284120474,24781],[61.58483901796785,243.09848390179678,24831],[72.55985993631896,244.1959859936319,24882],[87.09083816380883,245.64908381638088,24933],[72.5470734007223,249.68529265992777,24984],[60.866131566825175,250.85338684331748,25034],[76.26082362479366,249.31391763752063,25085]],{\"percent\":45,\"factor\":0.8,\"text\":\"Average\",\"color\":\"#990\"},821,\"B\",3]]]"],6620,[1358967573792,25700],"b-minor-octave-3"]';
$arrGame    = json_decode($strJsonGameString);

// Make sure user is logged in
if($_SESSION['UserObject']->id == 0)
{
    exit; // Don't proceed due to error
}

// Find the ID on the game played
$strGamename = $arrGame[5];

$rGameInfo = $oSql->Select('
    SELECT
        id
    FROM
        games
    WHERE
        deleted = 0
     && permlink = "'.$strGamename.'"
');
$oGameInfo = $rGameInfo->fetch_object();

// Did we find a GameID?
$iGameID = $oGameInfo->id;
if($iGameID == 0)
{
    exit;
}

// Save points into a variable
$iPoints        = $arrGame[3];

// When did the game start and end
$iStartTime     = $arrGame[4][0]; // In ms
$iGameTime      = $arrGame[4][1]; // In ms
$fGameDuration  = $arrGame[4][2]; // Decimal seconds

$strStartDate   = date('Y-m-d H:i:s', ($iStartTime / 1000));

// When did the game end
$strEndDateTime = date('Y-m-d H:i:s', (($iStartTime + $iGameTime) / 1000));

// Initialize analysis arrays
$arrTuneAnalyser = array();
$arrTactTuneAnalyser = array();
// Check if we're receiving an array
if(is_array($arrGame))
{
    $bIsFirstArray = true; // First array contains the tacts
	foreach($arrGame as $iDataEntry => $arrData)
	{
		if(is_array($arrData))
		{
			foreach($arrData as $iTactEntry => $strTactJSON)
			{
                if($bIsFirstArray)
                {
                    $arrTact = json_decode($strTactJSON);
                    if(is_array($arrTact))
                    {
                        // Check if this tact is already initialized, if note, then initialize it
                        if(!is_array($arrTactTuneAnalyser[$iTactEntry]))
                        {
                            $arrTactTuneAnalyser[$iTactEntry] = array(
                                'pct'           => 0,
                                'notes_played'  => 0
                            );
                        }
                        foreach($arrTact as $iNote => $arrNote)
                        {
                            if(is_array($arrNote))
                            {
                                foreach($arrNote as $iNoteInfoEntry => $arrNoteInfoEntry)
                                {
                                    // Some statistics for this perticular note
                                    $iPercentAccuracy   = $arrNoteInfoEntry[1]->percent;
                                    $iFactor            = $arrNoteInfoEntry[1]->factor;
                                    $strEvaluationText  = $arrNoteInfoEntry[1]->text;
                                    $strEvalTextColor   = $arrNoteInfoEntry[1]->color;
                                    //$iNotePoints        = $arrNoteInfoEntry[2];
                                    $strExpectedNote    = $arrNoteInfoEntry[3];
                                    $strExpectedOctave  = $arrNoteInfoEntry[4];

                                    // If this note in this octave isn't already in to the tune analyser array, then... well... do it!
                                    if(!is_array($arrTuneAnalyser[$strExpectedNote.','.$strExpectedOctave]))
                                    {
                                        $arrTuneAnalyser[$strExpectedNote.','.$strExpectedOctave] = array(
                                            'expected_freq' => 0,
                                            'pct'           => 0,
                                            'played'        => 0,
                                            'avg_freq'      => 0,
                                            'ticks'         => 0
                                        );
                                    }

                                    if(is_array($arrNoteInfoEntry[0]))
                                    {
                                        // Loop through each tick to find the avg frequency
                                        foreach($arrNoteInfoEntry as $iTicksEntry => $arrTicks)
                                        {
                                            if(is_array($arrTicks))
                                            {
                                                foreach($arrTicks as $iTickEntry => $arrTick)
                                                {
                                                    // Add to tune analyser
                                                    $arrTuneAnalyser[$strExpectedNote.','.$strExpectedOctave]['avg_freq'] += $arrTick[1];
                                                    $arrTuneAnalyser[$strExpectedNote.','.$strExpectedOctave]['ticks']++;

                                                }
                                            }
                                        }
                                    }

                                    // We temporarily save the SUM of the accuracy in the percentage entry in the spicific note array, we'll recalculate when we've looped through all of the music-data
                                    $arrTuneAnalyser[$strExpectedNote.','.$strExpectedOctave]['pct'] += $iPercentAccuracy;
                                    $arrTuneAnalyser[$strExpectedNote.','.$strExpectedOctave]['played']++;

                                    // Add to tact tune analyser
                                    $arrTactTuneAnalyser[$iTactEntry]['pct'] += $iPercentAccuracy;
                                    $arrTactTuneAnalyser[$iTactEntry]['notes_played']++;
                                }
                            }
                        }
                    }
                }
				if(is_array($arrNote))
				{

				}
			}
            $bIsFirstArray = false; // Done loading tacts!
		}
	}
}

// Now fetch all tunes so we can match each tune with the appropriate frequency
$rTones = $oSql->Select('
    SELECT
        tones
    FROM
        tones
');
$oTones = $rTones->fetch_object();

$arrTones = json_decode($oTones->tones);

// Calculate numbers from the tune analyzer
foreach($arrTuneAnalyser as $strTuneIdentifyer => $arrTuneAnalyzerData)
{
    // Calculate average precent
    $arrTuneAnalyser[$strTuneIdentifyer]['pct'] = $arrTuneAnalyzerData['pct'] / $arrTuneAnalyzerData['played'];

    // Calculate average frequency
    $arrTuneAnalyser[$strTuneIdentifyer]['avg_freq'] = $arrTuneAnalyzerData['avg_freq'] / $arrTuneAnalyzerData['ticks'];

    // Now look for the frequancy we actually needed we actually looked for

    // First identify tone and octave we're looking at
    $arrCurrentTone = explode(',', $strTuneIdentifyer);

    // Loop through all tones that we know of
    foreach($arrTones as $iToneEntry => $oToneInfo)
    {
        // Check if we've arrived at the correct tone
        if($arrCurrentTone[0] == $oToneInfo->name && $arrCurrentTone[1] == $oToneInfo->octav)
        {
            $arrTuneAnalyser[$strTuneIdentifyer]['expected_freq'] = $oToneInfo->hz;
        }
    }
}

// Calculate how good each tact was in percent
$arrTacts = array(); // Initializing an array which will contain avrage pct accuracy foreach tact
foreach($arrTactTuneAnalyser as $iTactNo => $arrTactInfo)
{
    $arrTacts[$iTactNo] = $arrTactInfo['pct'] / $arrTactInfo['notes_played'];
}

// JSON'ify statistics arrays
$strGameStatistics = json_encode($arrTuneAnalyser);
$strTactStatistics = json_encode($arrTacts);

// Now save it all :D

// Create array to insert
$arrSavegame = array(
    'user_id'               => $_SESSION['UserObject']->id,
    'game_id'               => $iGameID,
    'points'                => $iPoints,
    'game_start'            => $strStartDate,
    'game_finished'         => $strEndDateTime,
    'game_duration'         => $fGameDuration,
    'json_gamestring'       => $strJsonGameString,
    'json_statisticsstring' => $strGameStatistics,
    'json_tactstats'        => $strTactStatistics
);

// Insert it <3
$iGameHistoryID	= $oSql->Insert('users_games_history', $arrSavegame, 'Game saved');
echo json_encode(array(
	'game_history_id'	=>  $iGameHistoryID
));


// Now pull out some easy-to-lookup, for instance which tunes the player had most difficulties playing

// Will maybe be done later :D
?>
